name: Automated DB Backup

on:
  schedule:
    # Run daily at 02:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggers

jobs:
  backup:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install PostgreSQL 18 client
        run: |
          # Add the official PostgreSQL APT repo so we get pg_dump >= 18
          sudo apt-get install -y curl ca-certificates
          curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc \
            | sudo gpg --dearmor -o /usr/share/keyrings/pgdg.gpg
          echo "deb [signed-by=/usr/share/keyrings/pgdg.gpg] \
            http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" \
            | sudo tee /etc/apt/sources.list.d/pgdg.list
          sudo apt-get update
          sudo apt-get install -y postgresql-client-18
          pg_dump --version

      - name: Export database backup
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          mkdir -p backups
          TIMESTAMP=$(date -u +%Y%m%d_%H%M%S)

          if [ -n "$DATABASE_URL" ]; then
            echo "PostgreSQL backup via pg_dump..."
            pg_dump "$DATABASE_URL" --no-owner --no-acl \
              -f "backups/portfolio_${TIMESTAMP}.sql"
            echo "Backup saved to backups/portfolio_${TIMESTAMP}.sql"
          else
            echo "No DATABASE_URL secret configured — skipping backup."
            echo "To enable backups, add your Render PostgreSQL External URL"
            echo "as a GitHub Actions secret named DATABASE_URL."
            exit 0
          fi

          # Keep only the last 7 backups
          cd backups
          ls -t *.sql 2>/dev/null | tail -n +8 | xargs -r rm -v
          cd ..

      - name: Commit and push backup
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Only proceed if backups/ has files to commit
          if [ -d "backups" ] && [ -n "$(ls -A backups/*.sql 2>/dev/null)" ]; then
            git add backups/
            if git diff --cached --quiet; then
              echo "No changes to commit"
            else
              git commit -m "chore: automated DB backup $(date -u +%Y-%m-%d)"
              git push
            fi
          else
            echo "No backup files found — nothing to commit"
          fi
