name: Automated DB Backup

on:
  schedule:
    # Run daily at 02:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggers

jobs:
  backup:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Export database to SQL dump
        run: |
          python -c "
          import sqlite3, os, datetime
          db_path = 'instance/portfolio.db'
          if not os.path.exists(db_path):
              print('No database found â€” skipping backup.')
              exit(0)
          conn = sqlite3.connect(db_path)
          timestamp = datetime.datetime.utcnow().strftime('%Y%m%d_%H%M%S')
          backup_dir = 'backups'
          os.makedirs(backup_dir, exist_ok=True)
          dump_path = f'{backup_dir}/portfolio_{timestamp}.sql'
          with open(dump_path, 'w') as f:
              for line in conn.iterdump():
                  f.write(line + '\n')
          conn.close()
          print(f'Backup saved to {dump_path}')
          # Keep only the last 7 backups
          backups = sorted([
              os.path.join(backup_dir, f)
              for f in os.listdir(backup_dir) if f.endswith('.sql')
          ])
          for old in backups[:-7]:
              os.remove(old)
              print(f'Removed old backup: {old}')
          "

      - name: Commit and push backup
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add backups/
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: automated DB backup $(date -u +%Y-%m-%d)"
            git push
          fi
